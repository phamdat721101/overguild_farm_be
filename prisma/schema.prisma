generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String   @id @default(dbgenerated("gen_random_uuid()"))
  walletAddress   String   @unique(map: "users_walletAddress_key") @map("wallet_address")
  username        String?
  xp              Int      @default(0)
  reputationScore Int      @default(0) @map("reputation_score")
  createdAt       DateTime @default(now()) @map("created_at")
  // Primary network label for display only. Actual multi-chain
  // addresses can be handled separately later.
  network         String   @default("multi-chain")
  avatar          String?
  bio             String?
  twitter         String?
  github          String?
  discord         String?
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  inventoryItems  InventoryItem[]
  lands           Land[]
  missions        Mission[]
  missionLogs     MissionLog[]
  soulboundTokens SoulboundToken[]
  seeds           Seed[]

  @@map("users")
}

model Land {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  userId      String   @map("user_id")
  plotIndex   Int      @map("plot_index")
  soilQuality Json?    @default("{\"fertility\": 50, \"hydration\": 50}") @map("soil_quality")
  plant_id    String?  @unique
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plant       Plant?

  @@unique([userId, plotIndex])
  @@map("lands")
}

model Plant {
  id               String    @id @default(dbgenerated("gen_random_uuid()"))
  landId           String    @unique @map("land_id")
  type             String
  stage            String    @default("DIGGING")
  
  plantedAt        DateTime  @map("planted_at")
  lastInteractedAt DateTime  @map("last_interacted_at")
  
  // Digging phase
  diggingStartedAt DateTime?  @map("digging_started_at")
  diggingDuration  Int        @default(0) @map("digging_duration")
  diggingCompleted Boolean    @default(false) @map("digging_completed")
  
  // Growing phase
  growingStartedAt DateTime?  @map("growing_started_at")
  growingDuration  Int        @default(0) @map("growing_duration")
  
  // Interactions
  interactions     Int        @default(0)
  waterCount       Int        @default(0) @map("water_count")
  wateredBy        String[]   @default([]) @map("watered_by")
  lastWateredAt    DateTime?  @map("last_watered_at")
  
  // Game mechanics (add these missing fields)
  githubCommits    Int        @default(0) @map("github_commits")
  isGoldBranch     Boolean    @default(false) @map("is_gold_branch")
  
  // Harvest
  isHarvestable    Boolean    @default(false) @map("is_harvestable")
  harvestedAt      DateTime?  @map("harvested_at")
  fruitYield       Int        @default(0) @map("fruit_yield")
  
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")
  
  land             Land       @relation(fields: [landId], references: [id], onDelete: Cascade)
  
  @@index([landId])
  @@map("plants")
}

model Seed {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     String // ALGAE, MUSHROOM, TREE
  rarity   String @default("COMMON") // COMMON, RARE, EPIC, LEGENDARY (for TREE F0-F3)
  quantity Int    @default(1)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, type])
  @@map("seeds")
}

// --- INVENTORY ITEM (for all items: fruits, seeds, fertilizers, etc.) ---
// Seeds are stored as SEED_COMMON, SEED_RARE, SEED_EPIC, SEED_LEGENDARY in itemType
model InventoryItem {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  userId    String   @map("user_id")
  itemType  String   @map("item_type")
  amount    Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemType])
  @@map("inventory_items")
}

// --- MISSION ---
model Mission {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  userId      String   @map("user_id")
  missionType String   @map("mission_type")
  status      String   @default("active")
  progress    Int      @default(0)
  target      Int
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("missions")
}

// --- MISSION LOG ---
model MissionLog {
  id          String    @id @default(dbgenerated("gen_random_uuid()"))
  userId      String    @map("user_id")
  missionType String    @map("mission_type")
  progress    Int       @default(0)
  target      Int
  status      String
  resetAt     DateTime? @map("reset_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mission_logs")
}

model SoulboundToken {
  id       String   @id @default(dbgenerated("gen_random_uuid()"))
  userId   String   @map("user_id")
  name     String
  issuedAt DateTime @default(now()) @map("issued_at")
  metadata Json?
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("soulbound_tokens")
}

// --- EVENTS (local OverGuild events, decoupled from FundX) ---
model Event {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  name        String
  description String?
  location    String
  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("events")
}
