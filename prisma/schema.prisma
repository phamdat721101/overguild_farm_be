generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String               @id @default(dbgenerated("gen_random_uuid()"))
  walletAddress       String               @unique(map: "users_walletAddress_key") @map("wallet_address")
  username            String?
  xp                  Int                  @default(0)
  reputationScore     Int                  @default(0) @map("reputation_score")
  createdAt           DateTime             @default(now()) @map("created_at")
  network             String               @default("multi-chain")
  avatar              String?
  bio                 String?
  twitter             String?
  github              String?
  discord             String?
  updatedAt           DateTime             @default(now()) @updatedAt @map("updated_at")
  balanceGold         Int                  @default(0) @map("balance_gold")
  balanceRuby         Int                  @default(0) @map("balance_ruby")
  balanceGem          Int                  @default(0) @map("balance_gem")
  lastFreeWaterAt     DateTime?            @map("last_free_water_at") // ✅ Hydration: Last time user claimed free water
  dailyStreak         DailyStreak?
  inventoryItems      InventoryItem[]
  lands               Land[]
  missionLogs         MissionLog[]
  missions            Mission[]
  phygitalRedemptions PhygitalRedemption[]
  seeds               Seed[]
  shopPurchases       ShopPurchase[]
  soulboundTokens     SoulboundToken[]
  streakCheckins      StreakCheckin[]
  
  referrerId          String?              @map("referrer_id")
  referrer            User?                @relation("Referrals", fields: [referrerId], references: [id])
  referrals           User[]               @relation("Referrals")
  
  sentFriendRequests     FriendRequest[]   @relation("SentRequests")
  receivedFriendRequests FriendRequest[]   @relation("ReceivedRequests")
  friendships1           Friendship[]      @relation("User1Friendships")
  friendships2           Friendship[]      @relation("User2Friendships")
  sentMessages           Message[]         @relation("SentMessages")
  conversationMembers    ConversationMember[]
  
  // P2P Marketplace
  sentTrades             TradeRequest[]    @relation("SentTrades")
  receivedTrades         TradeRequest[]    @relation("ReceivedTrades")
  tradeItems             TradeItem[]       @relation("TradeItemOwner")
  tradeCurrencies        TradeCurrency[]   @relation("TradeCurrencyOwner")
  sellerListings         MarketListing[]   @relation("SellerListings")
  buyerListings          MarketListing[]   @relation("BuyerListings")

  @@map("users")
}

model Land {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  userId      String   @map("user_id")
  plotIndex   Int      @map("plot_index")
  soilQuality Json?    @default("{\"fertility\": 50, \"hydration\": 50}") @map("soil_quality")
  plant_id    String?  @unique
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plant       Plant?

  @@unique([userId, plotIndex])
  @@map("lands")
}

model Plant {
  id                String    @id @default(dbgenerated("gen_random_uuid()"))
  landId            String    @unique @map("land_id")
  type              String
  stage             String    @default("DIGGING")
  plantedAt         DateTime  @map("planted_at")
  lastInteractedAt  DateTime  @map("last_interacted_at")
  diggingStartedAt  DateTime? @map("digging_started_at")
  diggingDuration   Int       @default(0) @map("digging_duration")
  diggingCompleted  Boolean   @default(false) @map("digging_completed")
  growingStartedAt  DateTime? @map("growing_started_at")
  growingDuration   Int       @default(0) @map("growing_duration")
  interactions      Int       @default(0)
  waterCount        Int       @default(0) @map("water_count")
  wateredBy         String[]  @default([]) @map("watered_by")
  lastWateredAt     DateTime? @map("last_watered_at")
  githubCommits     Int       @default(0) @map("github_commits")
  isGoldBranch      Boolean   @default(false) @map("is_gold_branch")
  isHarvestable     Boolean   @default(false) @map("is_harvestable")
  harvestedAt       DateTime? @map("harvested_at")
  fruitYield        Int       @default(0) @map("fruit_yield")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  dailyWaterCount   Int       @default(0) @map("daily_water_count")
  lastWaterDate     DateTime? @map("last_water_date")
  
  // ✅ Hydration System
  waterBalance      Int       @default(0) @map("water_balance") // Hours of water remaining (1 drop = 3h)
  activeGrowthHours Int       @default(0) @map("active_growth_hours") // Total hours grown while healthy
  witheredAt        DateTime? @map("withered_at") // When water ran out
  
  land              Land      @relation(fields: [landId], references: [id], onDelete: Cascade)

  @@index([landId])
  @@index([lastWaterDate])
  @@map("plants")
}

model Seed {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  rarity    String   @default("COMMON")
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@map("seeds")
}

model InventoryItem {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  userId    String   @map("user_id")
  itemType  String   @map("item_type")
  amount    Int      @default(0)
  location  String   @default("STORAGE") @map("location") // STORAGE or BACKPACK
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemType, location])
  @@index([userId, location])
  @@map("inventory_items")
}

model Mission {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  userId      String   @map("user_id")
  missionType String   @map("mission_type")
  status      String   @default("active")
  progress    Int      @default(0)
  target      Int
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("missions")
}

model MissionLog {
  id          String    @id @default(dbgenerated("gen_random_uuid()"))
  userId      String    @map("user_id")
  missionType String    @map("mission_type")
  progress    Int       @default(0)
  target      Int
  status      String
  resetAt     DateTime? @map("reset_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mission_logs")
}

model SoulboundToken {
  id       String   @id @default(dbgenerated("gen_random_uuid()"))
  userId   String   @map("user_id")
  name     String
  issuedAt DateTime @default(now()) @map("issued_at")
  metadata Json?
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("soulbound_tokens")
}

model Event {
  id            String   @id @default(dbgenerated("gen_random_uuid()"))
  name          String
  description   String?
  location      String
  startTime     DateTime @map("start_time")
  endTime       DateTime @map("end_time")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")
  creatorWallet String   @map("creator_wallet")

  @@map("events")
}

model PhygitalRedemption {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  userId      String   @map("user_id")
  rewardKey   String   @map("reward_key")
  paymentType String   @map("payment_type")
  costAmount  Int      @map("cost_amount")
  status      String   @default("PENDING")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("phygital_redemptions")
}

model ShopPurchase {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  userId    String   @map("user_id")
  shopType  String   @map("shop_type")
  itemKey   String   @map("item_key")
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, shopType, itemKey, createdAt])
  @@map("shop_purchases")
}

model DailyStreak {
  id            String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId        String    @unique @map("user_id")
  currentStreak Int       @default(0) @map("current_streak")
  lastCheckinAt DateTime? @map("last_checkin_at")
  totalCycles   Int       @default(0) @map("total_cycles")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([lastCheckinAt, currentStreak])
  @@map("daily_streaks")
}

model StreakCheckin {
  id        String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId    String   @map("user_id")
  streakDay Int      @map("streak_day")
  rewards   Json     @map("rewards")
  checkinAt DateTime @default(now()) @map("checkin_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, checkinAt])
  @@map("streak_checkins")
}

model FriendRequest {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  senderId   String   @map("sender_id")
  receiverId String   @map("receiver_id")
  status     String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  
  sender   User @relation("SentRequests", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedRequests", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([receiverId, status])
  @@index([senderId, status])
  @@map("friend_requests")
}

model Friendship {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  user1Id   String   @map("user1_id")
  user2Id   String   @map("user2_id")
  createdAt DateTime @default(now()) @map("created_at")
  
  user1 User @relation("User1Friendships", fields: [user1Id], references: [id], onDelete: Cascade)
  user2 User @relation("User2Friendships", fields: [user2Id], references: [id], onDelete: Cascade)

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
  @@map("friendships")
}

model Conversation {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  type      String   @default("DIRECT") // DIRECT or GROUP
  name      String?  // For group chats
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  members  ConversationMember[]
  messages Message[]

  @@map("conversations")
}

model ConversationMember {
  id             String    @id @default(dbgenerated("gen_random_uuid()"))
  conversationId String    @map("conversation_id")
  userId         String    @map("user_id")
  joinedAt       DateTime  @default(now()) @map("joined_at")
  lastReadAt     DateTime? @map("last_read_at")
  
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@map("conversation_members")
}

model Message {
  id             String   @id @default(dbgenerated("gen_random_uuid()"))
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  content        String
  type           String   @default("TEXT") // TEXT, IMAGE, FILE
  createdAt      DateTime @default(now()) @map("created_at")
  
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}


// ==================== P2P MARKETPLACE ====================

// Trade request between two players (Ngọc Rồng style)
model TradeRequest {
  id                String    @id @default(dbgenerated("gen_random_uuid()"))
  senderId          String    @map("sender_id")
  receiverId        String    @map("receiver_id")
  status            String    @default("PENDING") // PENDING, ACCEPTED, COMPLETED, CANCELLED, EXPIRED
  senderConfirmed   Boolean   @default(false) @map("sender_confirmed")
  receiverConfirmed Boolean   @default(false) @map("receiver_confirmed")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  expiresAt         DateTime  @map("expires_at")
  
  sender     User            @relation("SentTrades", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User            @relation("ReceivedTrades", fields: [receiverId], references: [id], onDelete: Cascade)
  items      TradeItem[]
  currencies TradeCurrency[]

  @@index([senderId])
  @@index([receiverId])
  @@index([status])
  @@map("trade_requests")
}

// Items in a trade
model TradeItem {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  tradeId   String   @map("trade_id")
  ownerId   String   @map("owner_id")
  itemType  String   @map("item_type")
  amount    Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  
  trade TradeRequest @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  owner User         @relation("TradeItemOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([tradeId])
  @@map("trade_items")
}

// Currency (gold/gem) in a trade
model TradeCurrency {
  id           String   @id @default(dbgenerated("gen_random_uuid()"))
  tradeId      String   @map("trade_id")
  ownerId      String   @map("owner_id")
  currencyType String   @map("currency_type") // GOLD, GEM
  amount       Int      @default(0)
  createdAt    DateTime @default(now()) @map("created_at")
  
  trade TradeRequest @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  owner User         @relation("TradeCurrencyOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([tradeId])
  @@map("trade_currencies")
}

// Marketplace listing (sạp hàng)
model MarketListing {
  id        String    @id @default(dbgenerated("gen_random_uuid()"))
  sellerId  String    @map("seller_id")
  itemType  String    @map("item_type")
  amount    Int       @default(1)
  priceGold Int?      @map("price_gold")
  priceGem  Int?      @map("price_gem")
  status    String    @default("ACTIVE") // ACTIVE, SOLD, CANCELLED
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  soldAt    DateTime? @map("sold_at")
  buyerId   String?   @map("buyer_id")
  
  seller User  @relation("SellerListings", fields: [sellerId], references: [id], onDelete: Cascade)
  buyer  User? @relation("BuyerListings", fields: [buyerId], references: [id], onDelete: SetNull)

  @@index([sellerId])
  @@index([status])
  @@index([itemType])
  @@map("market_listings")
}

// Trade history log
model TradeLog {
  id                  String   @id @default(dbgenerated("gen_random_uuid()"))
  tradeId             String?  @map("trade_id")
  listingId           String?  @map("listing_id")
  type                String   // P2P_TRADE, MARKET_PURCHASE
  user1Id             String   @map("user1_id")
  user2Id             String?  @map("user2_id")
  itemsExchanged      Json?    @map("items_exchanged")
  currenciesExchanged Json?    @map("currencies_exchanged")
  createdAt           DateTime @default(now()) @map("created_at")

  @@map("trade_logs")
}
